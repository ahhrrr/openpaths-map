<!DOCTYPE html>
<html>
<head>
<title>OpenPaths Map</title>
<meta charset="utf-8">
  <style>
    .usa { fill: #ddc; }
  </style>
  <script src="http://d3js.org/d3.v3.min.js"></script>
  <script src="http://d3js.org/topojson.v0.min.js"></script>
  <script src="http://code.jquery.com/jquery-1.9.1.min.js"></script>
  <script>
    $(function() {
      var width = 960,
          height = 1160;

      var svg = d3.select("body").append("svg")
          .attr("width", width)
          .attr("height", height);

      d3.json("us.json", function(error, us) {
        console.log(us);

        var subunits = topojson.object(us, us.objects.subunits);
        var projection = d3.geo.albersUsa()
            .scale(1000)
            .translate([width / 2, height / 2]);

        var path = d3.geo.path()
            .projection(projection);

        svg.append("path")
            .datum(subunits)
            .attr("d", path)
            .attr("class", "usa");

        d3.json("openpaths.json", function(error, data) {
          var locations = convertToGeoJSON(data);
          debugger
          svg.append("path")
            .datum(locations)
            .attr("d", path)
            .attr("class", "place");
        });
      });
    });

    function convertToGeoJSON(data) {
      var locationsFromOpenPaths = d3.map(data);
      var features = [];

      locationsFromOpenPaths.forEach(function(key, value) {
        var feature = {
          type: "Feature",
          id: key,
          geometry: {
            type: "Point",
            coordinates: [value["lon"], value["lat"]]
          },
          properties: {
            version: value["version"],
            timestamp: value["t"],
            device: value["device"],
            altitude: value["alt"],
            os: value["os"]
          }
        };

        features.push(feature);
      });

      return { type: "FeatureCollection", features: features };
    };


  </script>
</head>
<body>
  <div id="content">
    <div id="chart"></div>
  </div>
</body>
</html>
